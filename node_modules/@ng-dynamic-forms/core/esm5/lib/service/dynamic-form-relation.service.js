/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { FormControl } from "@angular/forms";
import { AND_OPERATOR, DYNAMIC_MATCHERS, OR_OPERATOR } from "./dynamic-form-relation.matchers";
import { startWith } from "rxjs/operators";
import { merge } from "rxjs";
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-form-relation.matchers";
var DynamicFormRelationService = /** @class */ (function () {
    function DynamicFormRelationService(DYNAMIC_MATCHERS, injector) {
        this.DYNAMIC_MATCHERS = DYNAMIC_MATCHERS;
        this.injector = injector;
    }
    /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    DynamicFormRelationService.prototype.getRelatedFormControls = /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    function (model, group) {
        /** @type {?} */
        var conditionReducer = (/**
         * @param {?} controls
         * @param {?} condition
         * @return {?}
         */
        function (controls, condition) {
            /** @type {?} */
            var path = condition.rootPath || condition.id;
            if (!controls.hasOwnProperty(path)) {
                /** @type {?} */
                var control = condition.rootPath ? group.root.get(condition.rootPath) : group.get(condition.id);
                control instanceof FormControl ? controls[path] = control : console.warn("No related form control with id " + condition.id + " could be found");
            }
            return controls;
        });
        /** @type {?} */
        var relationReducer = (/**
         * @param {?} controls
         * @param {?} relation
         * @return {?}
         */
        function (controls, relation) { return relation.when.reduce(conditionReducer, controls); });
        return model.relations.reduce(relationReducer, {});
    };
    /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    DynamicFormRelationService.prototype.findRelationByMatcher = /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    function (relations, matcher) {
        return relations.find((/**
         * @param {?} relation
         * @return {?}
         */
        function (relation) { return [matcher.match, matcher.opposingMatch].includes(relation.match); }));
    };
    /**
     * @param {?} relation
     * @param {?} relatedFormControls
     * @param {?} matcher
     * @return {?}
     */
    DynamicFormRelationService.prototype.matchesCondition = /**
     * @param {?} relation
     * @param {?} relatedFormControls
     * @param {?} matcher
     * @return {?}
     */
    function (relation, relatedFormControls, matcher) {
        /** @type {?} */
        var operator = relation.operator || OR_OPERATOR;
        return relation.when.reduce((/**
         * @param {?} hasAlreadyMatched
         * @param {?} condition
         * @param {?} index
         * @return {?}
         */
        function (hasAlreadyMatched, condition, index) {
            var e_1, _a;
            /** @type {?} */
            var path = condition.rootPath || condition.id;
            /** @type {?} */
            var relatedFormControl;
            try {
                for (var _b = tslib_1.__values(Object.entries(relatedFormControls)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var _d = tslib_1.__read(_c.value, 2), key = _d[0], control = _d[1];
                    if (key === path) {
                        relatedFormControl = control;
                        break;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
            if (relatedFormControl && relation.match === matcher.match) {
                if (index > 0 && operator === AND_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                if (index > 0 && operator === OR_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                return condition.value === relatedFormControl.value || condition.status === relatedFormControl.status;
            }
            if (relatedFormControl && relation.match === matcher.opposingMatch) {
                if (index > 0 && operator === AND_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                if (index > 0 && operator === OR_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                return !(condition.value === relatedFormControl.value || condition.status === relatedFormControl.status);
            }
            return false;
        }), false);
    };
    /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    DynamicFormRelationService.prototype.subscribeRelations = /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    function (model, group, control) {
        var _this = this;
        /** @type {?} */
        var relatedFormControls = this.getRelatedFormControls(model, group);
        /** @type {?} */
        var subscriptions = [];
        Object.values(relatedFormControls).forEach((/**
         * @param {?} relatedControl
         * @return {?}
         */
        function (relatedControl) {
            /** @type {?} */
            var valueChanges = relatedControl.valueChanges.pipe(startWith(relatedControl.value));
            /** @type {?} */
            var statusChanges = relatedControl.statusChanges.pipe(startWith(relatedControl.status));
            subscriptions.push(merge(valueChanges, statusChanges).subscribe((/**
             * @return {?}
             */
            function () {
                _this.DYNAMIC_MATCHERS.forEach((/**
                 * @param {?} matcher
                 * @return {?}
                 */
                function (matcher) {
                    /** @type {?} */
                    var relation = _this.findRelationByMatcher(model.relations, matcher);
                    if (relation !== undefined) {
                        /** @type {?} */
                        var hasMatch = _this.matchesCondition(relation, relatedFormControls, matcher);
                        matcher.onChange(hasMatch, model, control, _this.injector);
                    }
                }));
            })));
        }));
        return subscriptions;
    };
    DynamicFormRelationService.decorators = [
        { type: Injectable, args: [{
                    providedIn: "root"
                },] }
    ];
    /** @nocollapse */
    DynamicFormRelationService.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_MATCHERS,] }] },
        { type: Injector }
    ]; };
    /** @nocollapse */ DynamicFormRelationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DynamicFormRelationService_Factory() { return new DynamicFormRelationService(i0.ɵɵinject(i1.DYNAMIC_MATCHERS, 8), i0.ɵɵinject(i0.INJECTOR)); }, token: DynamicFormRelationService, providedIn: "root" });
    return DynamicFormRelationService;
}());
export { DynamicFormRelationService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.DYNAMIC_MATCHERS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmctZHluYW1pYy1mb3Jtcy9jb3JlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxXQUFXLEVBQWEsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RCxPQUFPLEVBQ0gsWUFBWSxFQUNaLGdCQUFnQixFQUVoQixXQUFXLEVBQ2QsTUFBTSxrQ0FBa0MsQ0FBQztBQUUxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBZ0IsTUFBTSxNQUFNLENBQUM7OztBQUkzQztJQUtJLG9DQUEwRCxnQkFBNkMsRUFDbkYsUUFBa0I7UUFEb0IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUE2QjtRQUNuRixhQUFRLEdBQVIsUUFBUSxDQUFVO0lBQUcsQ0FBQzs7Ozs7O0lBRTFDLDJEQUFzQjs7Ozs7SUFBdEIsVUFBdUIsS0FBOEIsRUFBRSxLQUFnQjs7WUFFN0QsZ0JBQWdCOzs7OztRQUFHLFVBQUMsUUFBUSxFQUFFLFNBQVM7O2dCQUVuQyxJQUFJLEdBQUcsU0FBUyxDQUFDLFFBQVEsSUFBSSxTQUFTLENBQUMsRUFBRTtZQUUvQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRTs7b0JBRTFCLE9BQU8sR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVB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TyxhQUFhLENBQUM7SUFDekIsQ0FBQzs7Z0JBMUdKLFVBQVUsU0FBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckI7Ozs7NENBR2dCLFFBQVEsWUFBSSxNQUFNLFNBQUMsZ0JBQWdCO2dCQXBCdkIsUUFBUTs7O3FDQUFyQztDQTBIQyxBQTNHRCxJQTJHQztTQXhHWSwwQkFBMEI7Ozs7OztJQUV2QixzREFBMkY7Ozs7O0lBQzNGLDhDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEZvcm1Db250cm9sLCBGb3JtR3JvdXAgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcbmltcG9ydCB7IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsIH0gZnJvbSBcIi4uL21vZGVsL2R5bmFtaWMtZm9ybS1jb250cm9sLm1vZGVsXCI7XG5pbXBvcnQge1xuICAgIEFORF9PUEVSQVRPUixcbiAgICBEWU5BTUlDX01BVENIRVJTLFxuICAgIER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIsXG4gICAgT1JfT1BFUkFUT1Jcbn0gZnJvbSBcIi4vZHluYW1pYy1mb3JtLXJlbGF0aW9uLm1hdGNoZXJzXCI7XG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiwgfSBmcm9tIFwiLi4vbW9kZWwvbWlzYy9keW5hbWljLWZvcm0tY29udHJvbC1yZWxhdGlvbi5tb2RlbFwiO1xuaW1wb3J0IHsgc3RhcnRXaXRoIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBtZXJnZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSBcInJ4anNcIjtcblxuZXhwb3J0IHR5cGUgRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMgPSB7IFtrZXk6IHN0cmluZ106IEZvcm1Db250cm9sIH07XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiBcInJvb3RcIlxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljRm9ybVJlbGF0aW9uU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KERZTkFNSUNfTUFUQ0hFUlMpIHByaXZhdGUgRFlOQU1JQ19NQVRDSEVSUzogRHluYW1pY0Zvcm1Db250cm9sTWF0Y2hlcltdLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7fVxuXG4gICAgZ2V0UmVsYXRlZEZvcm1Db250cm9scyhtb2RlbDogRHluYW1pY0Zvcm1Db250cm9sTW9kZWwsIGdyb3VwOiBGb3JtR3JvdXApOiBEeW5hbWljUmVsYXRlZEZvcm1Db250cm9scyB7XG5cbiAgICAgICAgY29uc3QgY29uZGl0aW9uUmVkdWNlciA9IChjb250cm9scywgY29uZGl0aW9uKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBjb25kaXRpb24ucm9vdFBhdGggfHwgY29uZGl0aW9uLmlkO1xuXG4gICAgICAgICAgICBpZiAoIWNvbnRyb2xzLmhhc093blByb3BlcnR5KHBhdGgpKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBjb250cm9sID0gY29uZGl0aW9uLnJvb3RQYXRoID8gZ3JvdXAucm9vdC5nZXQoY29uZGl0aW9uLnJvb3RQYXRoKSA6IGdyb3VwLmdldChjb25kaXRpb24uaWQpO1xuXG4gICAgICAgICAgICAgICAgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sID8gY29udHJvbHNbcGF0aF0gPSBjb250cm9sIDogY29uc29sZS53YXJuKGBObyByZWxhdGVkIGZvcm0gY29udHJvbCB3aXRoIGlkICR7Y29uZGl0aW9uLmlkfSBjb3VsZCBiZSBmb3VuZGApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gY29udHJvbHM7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVsYXRpb25SZWR1Y2VyID0gKGNvbnRyb2xzLCByZWxhdGlvbikgPT4gcmVsYXRpb24ud2hlbi5yZWR1Y2UoY29uZGl0aW9uUmVkdWNlciwgY29udHJvbHMpO1xuXG4gICAgICAgIHJldHVybiBtb2RlbC5yZWxhdGlvbnMucmVkdWNlKHJlbGF0aW9uUmVkdWNlciwge30pO1xuICAgIH1cblxuICAgIGZpbmRSZWxhdGlvbkJ5TWF0Y2hlcihyZWxhdGlvbnM6IER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uW10sIG1hdGNoZXI6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIpOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiByZWxhdGlvbnMuZmluZChyZWxhdGlvbiA9PiBbbWF0Y2hlci5tYXRjaCwgbWF0Y2hlci5vcHBvc2luZ01hdGNoXS5pbmNsdWRlcyhyZWxhdGlvbi5tYXRjaCkpO1xuICAgIH1cblxuICAgIG1hdGNoZXNDb25kaXRpb24ocmVsYXRpb246IER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uLCByZWxhdGVkRm9ybUNvbnRyb2xzOiBEeW5hbWljUmVsYXRlZEZvcm1Db250cm9scywgbWF0Y2hlcjogRHluYW1pY0Zvcm1Db250cm9sTWF0Y2hlcik6IGJvb2xlYW4ge1xuXG4gICAgICAgIGNvbnN0IG9wZXJhdG9yID0gcmVsYXRpb24ub3BlcmF0b3IgfHwgT1JfT1BFUkFUT1I7XG5cbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLndoZW4ucmVkdWNlKChoYXNBbHJlYWR5TWF0Y2hlZCwgY29uZGl0aW9uLCBpbmRleCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gY29uZGl0aW9uLnJvb3RQYXRoIHx8IGNvbmRpdGlvbi5pZDtcblxuICAgICAgICAgICAgbGV0IHJlbGF0ZWRGb3JtQ29udHJvbDtcblxuICAgICAgICAgICAgZm9yIChsZXQgW2tleSwgY29udHJvbF0gb2YgT2JqZWN0LmVudHJpZXMocmVsYXRlZEZvcm1Db250cm9scykpIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSBwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbGF0ZWRGb3JtQ29udHJvbCA9IGNvbnRyb2w7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlbGF0ZWRGb3JtQ29udHJvbCAmJiByZWxhdGlvbi5tYXRjaCA9PT0gbWF0Y2hlci5tYXRjaCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gQU5EX09QRVJBVE9SICYmICFoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gT1JfT1BFUkFUT1IgJiYgaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmRpdGlvbi52YWx1ZSA9PT0gcmVsYXRlZEZvcm1Db250cm9sLnZhbHVlIHx8IGNvbmRpdGlvbi5zdGF0dXMgPT09IHJlbGF0ZWRGb3JtQ29udHJvbC5zdGF0dXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWxhdGVkRm9ybUNvbnRyb2wgJiYgcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIub3Bwb3NpbmdNYXRjaCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gQU5EX09QRVJBVE9SICYmIGhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IE9SX09QRVJBVE9SICYmICFoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuICEoY29uZGl0aW9uLnZhbHVlID09PSByZWxhdGVkRm9ybUNvbnRyb2wudmFsdWUgfHwgY29uZGl0aW9uLnN0YXR1cyA9PT0gcmVsYXRlZEZvcm1Db250cm9sLnN0YXR1cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICB9LCBmYWxzZSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlUmVsYXRpb25zKG1vZGVsOiBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCwgZ3JvdXA6IEZvcm1Hcm91cCwgY29udHJvbDogRm9ybUNvbnRyb2wpOiBTdWJzY3JpcHRpb25bXSB7XG5cbiAgICAgICAgY29uc3QgcmVsYXRlZEZvcm1Db250cm9scyA9IHRoaXMuZ2V0UmVsYXRlZEZvcm1Db250cm9scyhtb2RlbCwgZ3JvdXApLCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gICAgICAgIE9iamVjdC52YWx1ZXMocmVsYXRlZEZvcm1Db250cm9scykuZm9yRWFjaChyZWxhdGVkQ29udHJvbCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKHN0YXJ0V2l0aChyZWxhdGVkQ29udHJvbC52YWx1ZSkpO1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShzdGFydFdpdGgocmVsYXRlZENvbnRyb2wuc3RhdHVzKSk7XG5cbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnMucHVzaChtZXJnZSh2YWx1ZUNoYW5nZXMsIHN0YXR1c0NoYW5nZXMpLnN1YnNjcmliZSgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLkRZTkFNSUNfTUFUQ0hFUlMuZm9yRWFjaChtYXRjaGVyID0+IHtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWxhdGlvbiA9IHRoaXMuZmluZFJlbGF0aW9uQnlNYXRjaGVyKG1vZGVsLnJlbGF0aW9ucywgbWF0Y2hlcik7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aW9uICE9PSB1bmRlZmluZWQpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzTWF0Y2ggPSB0aGlzLm1hdGNoZXNDb25kaXRpb24ocmVsYXRpb24sIHJlbGF0ZWRGb3JtQ29udHJvbHMsIG1hdGNoZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlci5vbkNoYW5nZShoYXNNYXRjaCwgbW9kZWwsIGNvbnRyb2wsIHRoaXMuaW5qZWN0b3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBzdWJzY3JpcHRpb25zO1xuICAgIH1cbn1cbiJdfQ==