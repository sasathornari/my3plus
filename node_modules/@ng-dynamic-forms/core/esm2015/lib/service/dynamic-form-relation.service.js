/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { FormControl } from "@angular/forms";
import { AND_OPERATOR, DYNAMIC_MATCHERS, OR_OPERATOR } from "./dynamic-form-relation.matchers";
import { startWith } from "rxjs/operators";
import { merge } from "rxjs";
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-form-relation.matchers";
export class DynamicFormRelationService {
    /**
     * @param {?} DYNAMIC_MATCHERS
     * @param {?} injector
     */
    constructor(DYNAMIC_MATCHERS, injector) {
        this.DYNAMIC_MATCHERS = DYNAMIC_MATCHERS;
        this.injector = injector;
    }
    /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    getRelatedFormControls(model, group) {
        /** @type {?} */
        const conditionReducer = (/**
         * @param {?} controls
         * @param {?} condition
         * @return {?}
         */
        (controls, condition) => {
            /** @type {?} */
            const path = condition.rootPath || condition.id;
            if (!controls.hasOwnProperty(path)) {
                /** @type {?} */
                const control = condition.rootPath ? group.root.get(condition.rootPath) : group.get(condition.id);
                control instanceof FormControl ? controls[path] = control : console.warn(`No related form control with id ${condition.id} could be found`);
            }
            return controls;
        });
        /** @type {?} */
        const relationReducer = (/**
         * @param {?} controls
         * @param {?} relation
         * @return {?}
         */
        (controls, relation) => relation.when.reduce(conditionReducer, controls));
        return model.relations.reduce(relationReducer, {});
    }
    /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    findRelationByMatcher(relations, matcher) {
        return relations.find((/**
         * @param {?} relation
         * @return {?}
         */
        relation => [matcher.match, matcher.opposingMatch].includes(relation.match)));
    }
    /**
     * @param {?} relation
     * @param {?} relatedFormControls
     * @param {?} matcher
     * @return {?}
     */
    matchesCondition(relation, relatedFormControls, matcher) {
        /** @type {?} */
        const operator = relation.operator || OR_OPERATOR;
        return relation.when.reduce((/**
         * @param {?} hasAlreadyMatched
         * @param {?} condition
         * @param {?} index
         * @return {?}
         */
        (hasAlreadyMatched, condition, index) => {
            /** @type {?} */
            const path = condition.rootPath || condition.id;
            /** @type {?} */
            let relatedFormControl;
            for (let [key, control] of Object.entries(relatedFormControls)) {
                if (key === path) {
                    relatedFormControl = control;
                    break;
                }
            }
            if (relatedFormControl && relation.match === matcher.match) {
                if (index > 0 && operator === AND_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                if (index > 0 && operator === OR_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                return condition.value === relatedFormControl.value || condition.status === relatedFormControl.status;
            }
            if (relatedFormControl && relation.match === matcher.opposingMatch) {
                if (index > 0 && operator === AND_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                if (index > 0 && operator === OR_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                return !(condition.value === relatedFormControl.value || condition.status === relatedFormControl.status);
            }
            return false;
        }), false);
    }
    /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    subscribeRelations(model, group, control) {
        /** @type {?} */
        const relatedFormControls = this.getRelatedFormControls(model, group);
        /** @type {?} */
        const subscriptions = [];
        Object.values(relatedFormControls).forEach((/**
         * @param {?} relatedControl
         * @return {?}
         */
        relatedControl => {
            /** @type {?} */
            const valueChanges = relatedControl.valueChanges.pipe(startWith(relatedControl.value));
            /** @type {?} */
            const statusChanges = relatedControl.statusChanges.pipe(startWith(relatedControl.status));
            subscriptions.push(merge(valueChanges, statusChanges).subscribe((/**
             * @return {?}
             */
            () => {
                this.DYNAMIC_MATCHERS.forEach((/**
                 * @param {?} matcher
                 * @return {?}
                 */
                matcher => {
                    /** @type {?} */
                    const relation = this.findRelationByMatcher(model.relations, matcher);
                    if (relation !== undefined) {
                        /** @type {?} */
                        const hasMatch = this.matchesCondition(relation, relatedFormControls, matcher);
                        matcher.onChange(hasMatch, model, control, this.injector);
                    }
                }));
            })));
        }));
        return subscriptions;
    }
}
DynamicFormRelationService.decorators = [
    { type: Injectable, args: [{
                providedIn: "root"
            },] }
];
/** @nocollapse */
DynamicFormRelationService.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_MATCHERS,] }] },
    { type: Injector }
];
/** @nocollapse */ DynamicFormRelationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DynamicFormRelationService_Factory() { return new DynamicFormRelationService(i0.ɵɵinject(i1.DYNAMIC_MATCHERS, 8), i0.ɵɵinject(i0.INJECTOR)); }, token: DynamicFormRelationService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.DYNAMIC_MATCHERS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmctZHluYW1pYy1mb3Jtcy9jb3JlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLFdBQVcsRUFBYSxNQUFNLGdCQUFnQixDQUFDO0FBRXhELE9BQU8sRUFDSCxZQUFZLEVBQ1osZ0JBQWdCLEVBRWhCLFdBQVcsRUFDZCxNQUFNLGtDQUFrQyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFnQixNQUFNLE1BQU0sQ0FBQzs7O0FBTzNDLE1BQU0sT0FBTywwQkFBMEI7Ozs7O0lBRW5DLFlBQTBELGdCQUE2QyxFQUNuRixRQUFrQjtRQURvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTZCO1FBQ25GLGFBQVEsR0FBUixRQUFRLENBQVU7SUFBRyxDQUFDOzs7Ozs7SUFFMUMsc0JBQXNCLENBQUMsS0FBOEIsRUFBRSxLQUFnQjs7Y0FFN0QsZ0JBQWdCOzs7OztRQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFOztrQkFFdkMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxRQUFRLElBQUksU0FBUyxDQUFDLEVBQUU7WUFFL0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUU7O3NCQUUxQixPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FB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YUFDckI7Ozs7d0NBR2dCLFFBQVEsWUFBSSxNQUFNLFNBQUMsZ0JBQWdCO1lBcEJ2QixRQUFROzs7Ozs7OztJQW9CckIsc0RBQTJGOzs7OztJQUMzRiw4Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgRm9ybUdyb3VwIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCB9IGZyb20gXCIuLi9tb2RlbC9keW5hbWljLWZvcm0tY29udHJvbC5tb2RlbFwiO1xuaW1wb3J0IHtcbiAgICBBTkRfT1BFUkFUT1IsXG4gICAgRFlOQU1JQ19NQVRDSEVSUyxcbiAgICBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyLFxuICAgIE9SX09QRVJBVE9SXG59IGZyb20gXCIuL2R5bmFtaWMtZm9ybS1yZWxhdGlvbi5tYXRjaGVyc1wiO1xuaW1wb3J0IHsgRHluYW1pY0Zvcm1Db250cm9sUmVsYXRpb24sIH0gZnJvbSBcIi4uL21vZGVsL21pc2MvZHluYW1pYy1mb3JtLWNvbnRyb2wtcmVsYXRpb24ubW9kZWxcIjtcbmltcG9ydCB7IHN0YXJ0V2l0aCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgbWVyZ2UsIFN1YnNjcmlwdGlvbiB9IGZyb20gXCJyeGpzXCI7XG5cbmV4cG9ydCB0eXBlIER5bmFtaWNSZWxhdGVkRm9ybUNvbnRyb2xzID0geyBba2V5OiBzdHJpbmddOiBGb3JtQ29udHJvbCB9O1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogXCJyb290XCJcbn0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0Zvcm1SZWxhdGlvblNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQEluamVjdChEWU5BTUlDX01BVENIRVJTKSBwcml2YXRlIERZTkFNSUNfTUFUQ0hFUlM6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXJbXSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge31cblxuICAgIGdldFJlbGF0ZWRGb3JtQ29udHJvbHMobW9kZWw6IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsLCBncm91cDogRm9ybUdyb3VwKTogRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMge1xuXG4gICAgICAgIGNvbnN0IGNvbmRpdGlvblJlZHVjZXIgPSAoY29udHJvbHMsIGNvbmRpdGlvbikgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gY29uZGl0aW9uLnJvb3RQYXRoIHx8IGNvbmRpdGlvbi5pZDtcblxuICAgICAgICAgICAgaWYgKCFjb250cm9scy5oYXNPd25Qcm9wZXJ0eShwYXRoKSkge1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29udHJvbCA9IGNvbmRpdGlvbi5yb290UGF0aCA/IGdyb3VwLnJvb3QuZ2V0KGNvbmRpdGlvbi5yb290UGF0aCkgOiBncm91cC5nZXQoY29uZGl0aW9uLmlkKTtcblxuICAgICAgICAgICAgICAgIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQ29udHJvbCA/IGNvbnRyb2xzW3BhdGhdID0gY29udHJvbCA6IGNvbnNvbGUud2FybihgTm8gcmVsYXRlZCBmb3JtIGNvbnRyb2wgd2l0aCBpZCAke2NvbmRpdGlvbi5pZH0gY291bGQgYmUgZm91bmRgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xzO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlbGF0aW9uUmVkdWNlciA9IChjb250cm9scywgcmVsYXRpb24pID0+IHJlbGF0aW9uLndoZW4ucmVkdWNlKGNvbmRpdGlvblJlZHVjZXIsIGNvbnRyb2xzKTtcblxuICAgICAgICByZXR1cm4gbW9kZWwucmVsYXRpb25zLnJlZHVjZShyZWxhdGlvblJlZHVjZXIsIHt9KTtcbiAgICB9XG5cbiAgICBmaW5kUmVsYXRpb25CeU1hdGNoZXIocmVsYXRpb25zOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbltdLCBtYXRjaGVyOiBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyKTogRHluYW1pY0Zvcm1Db250cm9sUmVsYXRpb24gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gcmVsYXRpb25zLmZpbmQocmVsYXRpb24gPT4gW21hdGNoZXIubWF0Y2gsIG1hdGNoZXIub3Bwb3NpbmdNYXRjaF0uaW5jbHVkZXMocmVsYXRpb24ubWF0Y2gpKTtcbiAgICB9XG5cbiAgICBtYXRjaGVzQ29uZGl0aW9uKHJlbGF0aW9uOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiwgcmVsYXRlZEZvcm1Db250cm9sczogRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMsIG1hdGNoZXI6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIpOiBib29sZWFuIHtcblxuICAgICAgICBjb25zdCBvcGVyYXRvciA9IHJlbGF0aW9uLm9wZXJhdG9yIHx8IE9SX09QRVJBVE9SO1xuXG4gICAgICAgIHJldHVybiByZWxhdGlvbi53aGVuLnJlZHVjZSgoaGFzQWxyZWFkeU1hdGNoZWQsIGNvbmRpdGlvbiwgaW5kZXgpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgcGF0aCA9IGNvbmRpdGlvbi5yb290UGF0aCB8fCBjb25kaXRpb24uaWQ7XG5cbiAgICAgICAgICAgIGxldCByZWxhdGVkRm9ybUNvbnRyb2w7XG5cbiAgICAgICAgICAgIGZvciAobGV0IFtrZXksIGNvbnRyb2xdIG9mIE9iamVjdC5lbnRyaWVzKHJlbGF0ZWRGb3JtQ29udHJvbHMpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gcGF0aCkge1xuICAgICAgICAgICAgICAgICAgICByZWxhdGVkRm9ybUNvbnRyb2wgPSBjb250cm9sO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWxhdGVkRm9ybUNvbnRyb2wgJiYgcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIubWF0Y2gpIHtcblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IEFORF9PUEVSQVRPUiAmJiAhaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IE9SX09QRVJBVE9SICYmIGhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBjb25kaXRpb24udmFsdWUgPT09IHJlbGF0ZWRGb3JtQ29udHJvbC52YWx1ZSB8fCBjb25kaXRpb24uc3RhdHVzID09PSByZWxhdGVkRm9ybUNvbnRyb2wuc3RhdHVzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVsYXRlZEZvcm1Db250cm9sICYmIHJlbGF0aW9uLm1hdGNoID09PSBtYXRjaGVyLm9wcG9zaW5nTWF0Y2gpIHtcblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IEFORF9PUEVSQVRPUiAmJiBoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwICYmIG9wZXJhdG9yID09PSBPUl9PUEVSQVRPUiAmJiAhaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiAhKGNvbmRpdGlvbi52YWx1ZSA9PT0gcmVsYXRlZEZvcm1Db250cm9sLnZhbHVlIHx8IGNvbmRpdGlvbi5zdGF0dXMgPT09IHJlbGF0ZWRGb3JtQ29udHJvbC5zdGF0dXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgfSwgZmFsc2UpO1xuICAgIH1cblxuICAgIHN1YnNjcmliZVJlbGF0aW9ucyhtb2RlbDogRHluYW1pY0Zvcm1Db250cm9sTW9kZWwsIGdyb3VwOiBGb3JtR3JvdXAsIGNvbnRyb2w6IEZvcm1Db250cm9sKTogU3Vic2NyaXB0aW9uW10ge1xuXG4gICAgICAgIGNvbnN0IHJlbGF0ZWRGb3JtQ29udHJvbHMgPSB0aGlzLmdldFJlbGF0ZWRGb3JtQ29udHJvbHMobW9kZWwsIGdyb3VwKSwgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcblxuICAgICAgICBPYmplY3QudmFsdWVzKHJlbGF0ZWRGb3JtQ29udHJvbHMpLmZvckVhY2gocmVsYXRlZENvbnRyb2wgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCB2YWx1ZUNoYW5nZXMgPSByZWxhdGVkQ29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShzdGFydFdpdGgocmVsYXRlZENvbnRyb2wudmFsdWUpKTtcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1c0NoYW5nZXMgPSByZWxhdGVkQ29udHJvbC5zdGF0dXNDaGFuZ2VzLnBpcGUoc3RhcnRXaXRoKHJlbGF0ZWRDb250cm9sLnN0YXR1cykpO1xuXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25zLnB1c2gobWVyZ2UodmFsdWVDaGFuZ2VzLCBzdGF0dXNDaGFuZ2VzKS5zdWJzY3JpYmUoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgdGhpcy5EWU5BTUlDX01BVENIRVJTLmZvckVhY2gobWF0Y2hlciA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVsYXRpb24gPSB0aGlzLmZpbmRSZWxhdGlvbkJ5TWF0Y2hlcihtb2RlbC5yZWxhdGlvbnMsIG1hdGNoZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhc01hdGNoID0gdGhpcy5tYXRjaGVzQ29uZGl0aW9uKHJlbGF0aW9uLCByZWxhdGVkRm9ybUNvbnRyb2xzLCBtYXRjaGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXIub25DaGFuZ2UoaGFzTWF0Y2gsIG1vZGVsLCBjb250cm9sLCB0aGlzLmluamVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9ucztcbiAgICB9XG59XG4iXX0=