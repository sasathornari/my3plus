/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, Optional } from "@angular/core";
import { Validators, NG_VALIDATORS, NG_ASYNC_VALIDATORS } from "@angular/forms";
import { isObject, isString } from "../utils/core.utils";
import { DYNAMIC_VALIDATORS } from "./dynamic-form.validators";
import * as i0 from "@angular/core";
import * as i1 from "@angular/forms";
import * as i2 from "./dynamic-form.validators";
export class DynamicFormValidationService {
    /**
     * @param {?} NG_VALIDATORS
     * @param {?} NG_ASYNC_VALIDATORS
     * @param {?} DYNAMIC_VALIDATORS
     */
    constructor(NG_VALIDATORS, NG_ASYNC_VALIDATORS, DYNAMIC_VALIDATORS) {
        this.NG_VALIDATORS = NG_VALIDATORS;
        this.NG_ASYNC_VALIDATORS = NG_ASYNC_VALIDATORS;
        this.DYNAMIC_VALIDATORS = DYNAMIC_VALIDATORS;
    }
    /**
     * @private
     * @param {?} validatorName
     * @param {?=} validatorArgs
     * @param {?=} validatorsToken
     * @return {?}
     */
    getValidatorFn(validatorName, validatorArgs = null, validatorsToken = this.NG_VALIDATORS) {
        /** @type {?} */
        let validatorFn;
        if (Validators.hasOwnProperty(validatorName)) { // Built-in Angular Validators
            validatorFn = ((/** @type {?} */ (Validators)))[validatorName];
        }
        else { // Custom Validators
            if (this.DYNAMIC_VALIDATORS && this.DYNAMIC_VALIDATORS.has(validatorName)) {
                validatorFn = this.DYNAMIC_VALIDATORS.get(validatorName);
            }
            else if (validatorsToken) {
                validatorFn = validatorsToken.find((/**
                 * @param {?} validatorFn
                 * @return {?}
                 */
                validatorFn => validatorFn.name === validatorName));
            }
        }
        if (validatorFn === undefined) { // throw when no validator could be resolved
            throw new Error(`validator "${validatorName}" is not provided via NG_VALIDATORS, NG_ASYNC_VALIDATORS or DYNAMIC_FORM_VALIDATORS`);
        }
        if (validatorArgs !== null) {
            return ((/** @type {?} */ (validatorFn)))(validatorArgs);
        }
        return (/** @type {?} */ (validatorFn));
    }
    /**
     * @private
     * @param {?} validatorsConfig
     * @param {?=} validatorsToken
     * @return {?}
     */
    getValidatorFns(validatorsConfig, validatorsToken = this.NG_VALIDATORS) {
        /** @type {?} */
        let validatorFns = [];
        if (isObject(validatorsConfig)) {
            validatorFns = Object.keys(validatorsConfig).map((/**
             * @param {?} validatorConfigKey
             * @return {?}
             */
            validatorConfigKey => {
                /** @type {?} */
                let validatorConfigValue = ((/** @type {?} */ (validatorsConfig)))[validatorConfigKey];
                if (this.isValidatorDescriptor(validatorConfigValue)) {
                    /** @type {?} */
                    let descriptor = (/** @type {?} */ (validatorConfigValue));
                    return this.getValidatorFn(descriptor.name, descriptor.args, validatorsToken);
                }
                return this.getValidatorFn(validatorConfigKey, validatorConfigValue, validatorsToken);
            }));
        }
        return validatorFns;
    }
    /**
     * @private
     * @param {?} template
     * @param {?} model
     * @param {?=} error
     * @return {?}
     */
    parseErrorMessageConfig(template, model, error = null) {
        return template.replace(/{{\s*(.+?)\s*}}/mg, (/**
         * @param {?} _match
         * @param {?} expression
         * @return {?}
         */
        (_match, expression) => {
            /** @type {?} */
            let propertySource = model;
            /** @type {?} */
            let propertyName = expression;
            if (expression.indexOf("validator.") >= 0 && error) {
                propertySource = error;
                propertyName = expression.replace("validator.", "");
            }
            return propertySource[propertyName] !== null && propertySource[propertyName] !== undefined ?
                propertySource[propertyName] : null;
        }));
    }
    /**
     * @param {?} validatorName
     * @param {?=} validatorArgs
     * @return {?}
     */
    getValidator(validatorName, validatorArgs = null) {
        return (/** @type {?} */ (this.getValidatorFn(validatorName, validatorArgs)));
    }
    /**
     * @param {?} validatorName
     * @param {?=} validatorArgs
     * @return {?}
     */
    getAsyncValidator(validatorName, validatorArgs = null) {
        return (/** @type {?} */ (this.getValidatorFn(validatorName, validatorArgs, this.NG_ASYNC_VALIDATORS)));
    }
    /**
     * @param {?} validatorsConfig
     * @return {?}
     */
    getValidators(validatorsConfig) {
        return (/** @type {?} */ (this.getValidatorFns(validatorsConfig)));
    }
    /**
     * @param {?} asyncValidatorsConfig
     * @return {?}
     */
    getAsyncValidators(asyncValidatorsConfig) {
        return (/** @type {?} */ (this.getValidatorFns(asyncValidatorsConfig, this.NG_ASYNC_VALIDATORS)));
    }
    /**
     * @param {?} validatorsConfig
     * @param {?} control
     * @param {?} model
     * @return {?}
     */
    updateValidators(validatorsConfig, control, model) {
        model.validators = validatorsConfig;
        if (validatorsConfig === null) {
            control.clearValidators();
        }
        else {
            control.setValidators(this.getValidators(validatorsConfig));
        }
        control.updateValueAndValidity();
    }
    /**
     * @param {?} asyncValidatorsConfig
     * @param {?} control
     * @param {?} model
     * @return {?}
     */
    updateAsyncValidators(asyncValidatorsConfig, control, model) {
        model.asyncValidators = asyncValidatorsConfig;
        if (asyncValidatorsConfig === null) {
            control.clearAsyncValidators();
        }
        else {
            control.setAsyncValidators(this.getAsyncValidators(asyncValidatorsConfig));
        }
        control.updateValueAndValidity();
    }
    /**
     * @param {?} control
     * @param {?} model
     * @return {?}
     */
    createErrorMessages(control, model) {
        /** @type {?} */
        let messages = [];
        if (model.hasErrorMessages) {
            /** @type {?} */
            let messagesConfig = (/** @type {?} */ (model.errorMessages));
            Object.keys(control.errors || {}).forEach((/**
             * @param {?} validationErrorKey
             * @return {?}
             */
            validationErrorKey => {
                /** @type {?} */
                let messageKey = validationErrorKey;
                if (validationErrorKey === "minlength" || validationErrorKey === "maxlength") {
                    messageKey = messageKey.replace("length", "Length");
                }
                if (messagesConfig.hasOwnProperty(messageKey)) {
                    /** @type {?} */
                    let validationError = control.getError(validationErrorKey);
                    /** @type {?} */
                    let messageTemplate = (/** @type {?} */ (messagesConfig[messageKey]));
                    messages.push(this.parseErrorMessageConfig(messageTemplate, model, validationError));
                }
            }));
        }
        return messages;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    isFormHook(value) {
        return isString(value) && ["blur", "change", "submit"].indexOf(value) !== -1;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    isValidatorDescriptor(value) {
        if (isObject(value)) {
            return value.hasOwnProperty("name") && value.hasOwnProperty("args");
        }
        return false;
    }
}
DynamicFormValidationService.decorators = [
    { type: Injectable, args: [{
                providedIn: "root"
            },] }
];
/** @nocollapse */
DynamicFormValidationService.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [NG_VALIDATORS,] }] },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [NG_ASYNC_VALIDATORS,] }] },
    { type: Map, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_VALIDATORS,] }] }
];
/** @nocollapse */ DynamicFormValidationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DynamicFormValidationService_Factory() { return new DynamicFormValidationService(i0.ɵɵinject(i1.NG_VALIDATORS, 8), i0.ɵɵinject(i1.NG_ASYNC_VALIDATORS, 8), i0.ɵɵinject(i2.DYNAMIC_VALIDATORS, 8)); }, token: DynamicFormValidationService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicFormValidationService.prototype.NG_VALIDATORS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormValidationService.prototype.NG_ASYNC_VALIDATORS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormValidationService.prototype.DYNAMIC_VALIDATORS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZy1keW5hbWljLWZvcm1zL2NvcmUvIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9keW5hbWljLWZvcm0tdmFsaWRhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUlILFVBQVUsRUFDVixhQUFhLEVBQ2IsbUJBQW1CLEVBQ3RCLE1BQU0sZ0JBQWdCLENBQUM7QUFNeEIsT0FBTyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQWdELE1BQU0sMkJBQTJCLENBQUM7Ozs7QUFLN0csTUFBTSxPQUFPLDRCQUE0Qjs7Ozs7O0lBRXJDLFlBQXVELGFBQTRCLEVBQ3RCLG1CQUF1QyxFQUN4QyxrQkFBNkQ7UUFGbEUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDdEIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFvQjtRQUN4Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTJDO0lBQUcsQ0FBQzs7Ozs7Ozs7SUFHckgsY0FBYyxDQUFDLGFBQXFCLEVBQUUsZ0JBQXFCLElBQUksRUFDaEQsa0JBQW1DLElBQUksQ0FBQyxhQUFhOztZQUVwRSxXQUFxRDtRQUV6RCxJQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSw4QkFBOEI7WUFFMUUsV0FBVyxHQUFHLENBQUMsbUJBQUEsVUFBVSxFQUFPLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUVwRDthQUFNLEVBQUUsb0JBQW9CO1lBRXpCLElBQUksSUFBSSxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUU7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Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7Ozs7d0NBR2dCLFFBQVEsWUFBSSxNQUFNLFNBQUMsYUFBYTt3Q0FDaEMsUUFBUSxZQUFJLE1BQU0sU0FBQyxtQkFBbUI7WUFDNkIsR0FBRyx1QkFBdEUsUUFBUSxZQUFJLE1BQU0sU0FBQyxrQkFBa0I7Ozs7Ozs7O0lBRnRDLHFEQUF1RTs7Ozs7SUFDdkUsMkRBQXdGOzs7OztJQUN4RiwwREFBNkciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QsIE9wdGlvbmFsIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7XG4gICAgQWJzdHJhY3RDb250cm9sLFxuICAgIEFzeW5jVmFsaWRhdG9yRm4sXG4gICAgVmFsaWRhdG9yRm4sXG4gICAgVmFsaWRhdG9ycyxcbiAgICBOR19WQUxJREFUT1JTLFxuICAgIE5HX0FTWU5DX1ZBTElEQVRPUlNcbn0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCB9IGZyb20gXCIuLi9tb2RlbC9keW5hbWljLWZvcm0tY29udHJvbC5tb2RlbFwiO1xuaW1wb3J0IHtcbiAgICBEeW5hbWljVmFsaWRhdG9yRGVzY3JpcHRvcixcbiAgICBEeW5hbWljVmFsaWRhdG9yc0NvbmZpZ1xufSBmcm9tIFwiLi4vbW9kZWwvbWlzYy9keW5hbWljLWZvcm0tY29udHJvbC12YWxpZGF0aW9uLm1vZGVsXCI7XG5pbXBvcnQgeyBpc09iamVjdCwgaXNTdHJpbmcgfSBmcm9tIFwiLi4vdXRpbHMvY29yZS51dGlsc1wiO1xuaW1wb3J0IHsgRFlOQU1JQ19WQUxJREFUT1JTLCBWYWxpZGF0b3IsIFZhbGlkYXRvckZhY3RvcnksIFZhbGlkYXRvcnNUb2tlbiB9IGZyb20gXCIuL2R5bmFtaWMtZm9ybS52YWxpZGF0b3JzXCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiBcInJvb3RcIlxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlIHtcblxuICAgIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIEBJbmplY3QoTkdfVkFMSURBVE9SUykgcHJpdmF0ZSBOR19WQUxJREFUT1JTOiBWYWxpZGF0b3JGbltdLFxuICAgICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTkdfQVNZTkNfVkFMSURBVE9SUykgcHJpdmF0ZSBOR19BU1lOQ19WQUxJREFUT1JTOiBBc3luY1ZhbGlkYXRvckZuW10sXG4gICAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChEWU5BTUlDX1ZBTElEQVRPUlMpIHByaXZhdGUgRFlOQU1JQ19WQUxJREFUT1JTOiBNYXA8c3RyaW5nLCBWYWxpZGF0b3IgfCBWYWxpZGF0b3JGYWN0b3J5Pikge31cblxuXG4gICAgcHJpdmF0ZSBnZXRWYWxpZGF0b3JGbih2YWxpZGF0b3JOYW1lOiBzdHJpbmcsIHZhbGlkYXRvckFyZ3M6IGFueSA9IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3JzVG9rZW46IFZhbGlkYXRvcnNUb2tlbiA9IHRoaXMuTkdfVkFMSURBVE9SUyk6IFZhbGlkYXRvciB8IG5ldmVyIHtcblxuICAgICAgICBsZXQgdmFsaWRhdG9yRm46IFZhbGlkYXRvckZhY3RvcnkgfCBWYWxpZGF0b3IgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgaWYgKFZhbGlkYXRvcnMuaGFzT3duUHJvcGVydHkodmFsaWRhdG9yTmFtZSkpIHsgLy8gQnVpbHQtaW4gQW5ndWxhciBWYWxpZGF0b3JzXG5cbiAgICAgICAgICAgIHZhbGlkYXRvckZuID0gKFZhbGlkYXRvcnMgYXMgYW55KVt2YWxpZGF0b3JOYW1lXTtcblxuICAgICAgICB9IGVsc2UgeyAvLyBDdXN0b20gVmFsaWRhdG9yc1xuXG4gICAgICAgICAgICBpZiAodGhpcy5EWU5BTUlDX1ZBTElEQVRPUlMgJiYgdGhpcy5EWU5BTUlDX1ZBTElEQVRPUlMuaGFzKHZhbGlkYXRvck5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdmFsaWRhdG9yRm4gPSB0aGlzLkRZTkFNSUNfVkFMSURBVE9SUy5nZXQodmFsaWRhdG9yTmFtZSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsaWRhdG9yc1Rva2VuKSB7XG4gICAgICAgICAgICAgICAgdmFsaWRhdG9yRm4gPSB2YWxpZGF0b3JzVG9rZW4uZmluZCh2YWxpZGF0b3JGbiA9PiB2YWxpZGF0b3JGbi5uYW1lID09PSB2YWxpZGF0b3JOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0b3JGbiA9PT0gdW5kZWZpbmVkKSB7IC8vIHRocm93IHdoZW4gbm8gdmFsaWRhdG9yIGNvdWxkIGJlIHJlc29sdmVkXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHZhbGlkYXRvciBcIiR7dmFsaWRhdG9yTmFtZX1cIiBpcyBub3QgcHJvdmlkZWQgdmlhIE5HX1ZBTElEQVRPUlMsIE5HX0FTWU5DX1ZBTElEQVRPUlMgb3IgRFlOQU1JQ19GT1JNX1ZBTElEQVRPUlNgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0b3JBcmdzICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gKHZhbGlkYXRvckZuIGFzIFZhbGlkYXRvckZhY3RvcnkpKHZhbGlkYXRvckFyZ3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbGlkYXRvckZuIGFzIFZhbGlkYXRvcjtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgZ2V0VmFsaWRhdG9yRm5zKHZhbGlkYXRvcnNDb25maWc6IER5bmFtaWNWYWxpZGF0b3JzQ29uZmlnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcnNUb2tlbjogVmFsaWRhdG9yc1Rva2VuID0gdGhpcy5OR19WQUxJREFUT1JTKTogVmFsaWRhdG9yW10ge1xuXG4gICAgICAgIGxldCB2YWxpZGF0b3JGbnM6IFZhbGlkYXRvcltdID0gW107XG5cbiAgICAgICAgaWYgKGlzT2JqZWN0KHZhbGlkYXRvcnNDb25maWcpKSB7XG5cbiAgICAgICAgICAgIHZhbGlkYXRvckZucyA9IE9iamVjdC5rZXlzKHZhbGlkYXRvcnNDb25maWcpLm1hcCh2YWxpZGF0b3JDb25maWdLZXkgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IHZhbGlkYXRvckNvbmZpZ1ZhbHVlID0gKHZhbGlkYXRvcnNDb25maWcgYXMgRHluYW1pY1ZhbGlkYXRvcnNDb25maWcpW3ZhbGlkYXRvckNvbmZpZ0tleV07XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1ZhbGlkYXRvckRlc2NyaXB0b3IodmFsaWRhdG9yQ29uZmlnVmFsdWUpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IGRlc2NyaXB0b3IgPSB2YWxpZGF0b3JDb25maWdWYWx1ZSBhcyBEeW5hbWljVmFsaWRhdG9yRGVzY3JpcHRvcjtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0b3JGbihkZXNjcmlwdG9yLm5hbWUsIGRlc2NyaXB0b3IuYXJncywgdmFsaWRhdG9yc1Rva2VuKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0b3JGbih2YWxpZGF0b3JDb25maWdLZXksIHZhbGlkYXRvckNvbmZpZ1ZhbHVlLCB2YWxpZGF0b3JzVG9rZW4pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsaWRhdG9yRm5zO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBwYXJzZUVycm9yTWVzc2FnZUNvbmZpZyh0ZW1wbGF0ZTogc3RyaW5nLCBtb2RlbDogRHluYW1pY0Zvcm1Db250cm9sTW9kZWwsIGVycm9yOiBhbnkgPSBudWxsKTogc3RyaW5nIHtcblxuICAgICAgICByZXR1cm4gdGVtcGxhdGUucmVwbGFjZSgve3tcXHMqKC4rPylcXHMqfX0vbWcsIChfbWF0Y2g6IHN0cmluZywgZXhwcmVzc2lvbjogc3RyaW5nKSA9PiB7XG5cbiAgICAgICAgICAgIGxldCBwcm9wZXJ0eVNvdXJjZTogYW55ID0gbW9kZWwsXG4gICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiBzdHJpbmcgPSBleHByZXNzaW9uO1xuXG4gICAgICAgICAgICBpZiAoZXhwcmVzc2lvbi5pbmRleE9mKFwidmFsaWRhdG9yLlwiKSA+PSAwICYmIGVycm9yKSB7XG5cbiAgICAgICAgICAgICAgICBwcm9wZXJ0eVNvdXJjZSA9IGVycm9yO1xuICAgICAgICAgICAgICAgIHByb3BlcnR5TmFtZSA9IGV4cHJlc3Npb24ucmVwbGFjZShcInZhbGlkYXRvci5cIiwgXCJcIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eVNvdXJjZVtwcm9wZXJ0eU5hbWVdICE9PSBudWxsICYmIHByb3BlcnR5U291cmNlW3Byb3BlcnR5TmFtZV0gIT09IHVuZGVmaW5lZCA/XG4gICAgICAgICAgICAgICAgcHJvcGVydHlTb3VyY2VbcHJvcGVydHlOYW1lXSA6IG51bGw7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgZ2V0VmFsaWRhdG9yKHZhbGlkYXRvck5hbWU6IHN0cmluZywgdmFsaWRhdG9yQXJnczogYW55ID0gbnVsbCk6IFZhbGlkYXRvckZuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsaWRhdG9yRm4odmFsaWRhdG9yTmFtZSwgdmFsaWRhdG9yQXJncykgYXMgVmFsaWRhdG9yRm47XG4gICAgfVxuXG5cbiAgICBnZXRBc3luY1ZhbGlkYXRvcih2YWxpZGF0b3JOYW1lOiBzdHJpbmcsIHZhbGlkYXRvckFyZ3M6IGFueSA9IG51bGwpOiBBc3luY1ZhbGlkYXRvckZuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsaWRhdG9yRm4odmFsaWRhdG9yTmFtZSwgdmFsaWRhdG9yQXJncywgdGhpcy5OR19BU1lOQ19WQUxJREFUT1JTKSBhcyBBc3luY1ZhbGlkYXRvckZuO1xuICAgIH1cblxuXG4gICAgZ2V0VmFsaWRhdG9ycyh2YWxpZGF0b3JzQ29uZmlnOiBEeW5hbWljVmFsaWRhdG9yc0NvbmZpZyk6IFZhbGlkYXRvckZuW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWxpZGF0b3JGbnModmFsaWRhdG9yc0NvbmZpZykgYXMgVmFsaWRhdG9yRm5bXTtcbiAgICB9XG5cblxuICAgIGdldEFzeW5jVmFsaWRhdG9ycyhhc3luY1ZhbGlkYXRvcnNDb25maWc6IER5bmFtaWNWYWxpZGF0b3JzQ29uZmlnKTogQXN5bmNWYWxpZGF0b3JGbltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsaWRhdG9yRm5zKGFzeW5jVmFsaWRhdG9yc0NvbmZpZywgdGhpcy5OR19BU1lOQ19WQUxJREFUT1JTKSBhcyBBc3luY1ZhbGlkYXRvckZuW107XG4gICAgfVxuXG5cbiAgICB1cGRhdGVWYWxpZGF0b3JzKHZhbGlkYXRvcnNDb25maWc6IER5bmFtaWNWYWxpZGF0b3JzQ29uZmlnIHwgbnVsbCwgY29udHJvbDogQWJzdHJhY3RDb250cm9sLFxuICAgICAgICAgICAgICAgICAgICAgbW9kZWw6IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsKTogdm9pZCB7XG5cbiAgICAgICAgbW9kZWwudmFsaWRhdG9ycyA9IHZhbGlkYXRvcnNDb25maWc7XG5cbiAgICAgICAgaWYgKHZhbGlkYXRvcnNDb25maWcgPT09IG51bGwpIHtcblxuICAgICAgICAgICAgY29udHJvbC5jbGVhclZhbGlkYXRvcnMoKTtcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29udHJvbC5zZXRWYWxpZGF0b3JzKHRoaXMuZ2V0VmFsaWRhdG9ycyh2YWxpZGF0b3JzQ29uZmlnKSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcbiAgICB9XG5cblxuICAgIHVwZGF0ZUFzeW5jVmFsaWRhdG9ycyhhc3luY1ZhbGlkYXRvcnNDb25maWc6IER5bmFtaWNWYWxpZGF0b3JzQ29uZmlnIHwgbnVsbCwgY29udHJvbDogQWJzdHJhY3RDb250cm9sLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbDogRHluYW1pY0Zvcm1Db250cm9sTW9kZWwpOiB2b2lkIHtcblxuICAgICAgICBtb2RlbC5hc3luY1ZhbGlkYXRvcnMgPSBhc3luY1ZhbGlkYXRvcnNDb25maWc7XG5cbiAgICAgICAgaWYgKGFzeW5jVmFsaWRhdG9yc0NvbmZpZyA9PT0gbnVsbCkge1xuXG4gICAgICAgICAgICBjb250cm9sLmNsZWFyQXN5bmNWYWxpZGF0b3JzKCk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRyb2wuc2V0QXN5bmNWYWxpZGF0b3JzKHRoaXMuZ2V0QXN5bmNWYWxpZGF0b3JzKGFzeW5jVmFsaWRhdG9yc0NvbmZpZykpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29udHJvbC51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XG4gICAgfVxuXG5cbiAgICBjcmVhdGVFcnJvck1lc3NhZ2VzKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCwgbW9kZWw6IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsKTogc3RyaW5nW10ge1xuXG4gICAgICAgIGxldCBtZXNzYWdlczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAobW9kZWwuaGFzRXJyb3JNZXNzYWdlcykge1xuXG4gICAgICAgICAgICBsZXQgbWVzc2FnZXNDb25maWcgPSBtb2RlbC5lcnJvck1lc3NhZ2VzIGFzIER5bmFtaWNWYWxpZGF0b3JzQ29uZmlnO1xuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhjb250cm9sLmVycm9ycyB8fCB7fSkuZm9yRWFjaCh2YWxpZGF0aW9uRXJyb3JLZXkgPT4ge1xuXG4gICAgICAgICAgICAgICAgbGV0IG1lc3NhZ2VLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXk7XG5cbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yS2V5ID09PSBcIm1pbmxlbmd0aFwiIHx8IHZhbGlkYXRpb25FcnJvcktleSA9PT0gXCJtYXhsZW5ndGhcIikge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlS2V5ID0gbWVzc2FnZUtleS5yZXBsYWNlKFwibGVuZ3RoXCIsIFwiTGVuZ3RoXCIpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlc0NvbmZpZy5oYXNPd25Qcm9wZXJ0eShtZXNzYWdlS2V5KSkge1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWxpZGF0aW9uRXJyb3IgPSBjb250cm9sLmdldEVycm9yKHZhbGlkYXRpb25FcnJvcktleSksXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlVGVtcGxhdGUgPSBtZXNzYWdlc0NvbmZpZ1ttZXNzYWdlS2V5XSBhcyBzdHJpbmc7XG5cbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh0aGlzLnBhcnNlRXJyb3JNZXNzYWdlQ29uZmlnKG1lc3NhZ2VUZW1wbGF0ZSwgbW9kZWwsIHZhbGlkYXRpb25FcnJvcikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2VzO1xuICAgIH1cblxuXG4gICAgaXNGb3JtSG9vayh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgJiYgW1wiYmx1clwiLCBcImNoYW5nZVwiLCBcInN1Ym1pdFwiXS5pbmRleE9mKHZhbHVlKSAhPT0gLTE7XG4gICAgfVxuXG5cbiAgICBpc1ZhbGlkYXRvckRlc2NyaXB0b3IodmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuXG4gICAgICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eShcIm5hbWVcIikgJiYgdmFsdWUuaGFzT3duUHJvcGVydHkoXCJhcmdzXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbiJdfQ==